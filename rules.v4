# IPtables Chains

# -----------------------------------------------------------------------------------------------------------

# PREROUTING 

# 네트워크 인터페이스 카드 (NIC)에 들어가는 패킷에 적용

# INPUT

# 로컬 소켓으로 향하는 패킷에 적용

# OUTPUT

# 서버가 전송 한 (로컬로 생성 된) 패킷에 적용

# -----------------------------------------------------------------------------------------------------------


# iptable로 디도스 공격을 차단하려면 iptables 규칙의 성능이 매우 중요하다. 대부분의 TCP 기반 디도스 공격 유형은 높은 패킷 속도를 사용하는데, 이는 초당 많은 수의 

# 패킷이 서버를 다운시키는 원인이 된다는 것을 의미한다. 그렇기 때문에 가능한 초당 많은 패킷을 처리하고 차단할 수 있는지 확인하고 싶은 것이다.

# iptables를 사용하여 DDoS 공격을 차단하는 방법에 대한 모든 지침은 필터 표와 INPUT 체인을 안티 디도스 규칙에 사용한다는 것을 알 수 있다.

# 이 접근법의 문제는 INPUT 체인은 PREROUTING과 FORWARD 체인이 끝난 후에만 처리되므로 패킷이 이 두 체인과 일치하지 않을 경우에만 적용된다는 것이다.

# 이것은 자원을 소비하는 패킷의 필터링을 지연시킨다. 결론적으로, 우리의 규칙을 가능한 한 효과적으로 만들기 위해서, 우리는 가능한 한  ANTI 디도스 규칙을 사슬 위로 

# 옮겨야 한다. 패킷에 적용할 수 있는 첫 번째 체인은 PREROUTING 체인이므로 우리는 이 체인을 사용하여 불량 패킷을 필터링한다.

# 출처 : https://javapipe.com/blog/iptables-ddos-protection/ 사용 허락 받았습니다.

# Generated by iptables-save v1.6.1 on Fri Dec 13 12:26:41 2019
*mangle
:PREROUTING ACCEPT [1946:356388]
:INPUT ACCEPT [1177:161840]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [1261:135546]
:POSTROUTING ACCEPT [1151:123802]

# ICMP는 호스트가 여전히 살아 있는지 확인하기 위해 호스트를 ping하는 데만 사용됩니다. 
# 일반적으로 필요하지 않으며 공격 대상 탐지, Ping of Death (ping flood), ICMP flood 및 ICMP fragmentation flood에 사용되기 때문에 
# 모든 ICMP 패킷을 차단합니다.

-A PREROUTING -p icmp -j DROP 

# C&C IP 차단 ( https://exchange.xforce.ibmcloud.com/collection/Botnet-Command-and-Control-Servers-7ac6c4578facafa0de50b72e7bf8f8c4 ) 
-A PREROUTING -s 222.186.175.0/24 -j DROP
-A PREROUTING -s 222.186.175.0/24 -j DROP
-A PREROUTING -s 222.92.0.0/24 -j DROP
-A PREROUTING -s 222.92.0.0/24 -j DROP
-A PREROUTING -s 222.186.180.0/24 -j DROP
-A PREROUTING -s 222.186.180.0/24 -j DROP
-A PREROUTING -s 15.139.128.0/24 -j DROP
-A PREROUTING -s 239.255.102.0/24 -j DROP
-A PREROUTING -s 52.192.7.0/24 -j DROP
-A PREROUTING -s 15.164.81.0/24 -j DROP
-A PREROUTING -s 119.207.64.0/24 -j DROP
-A PREROUTING -s 15.139.128.0/24 -j DROP
-A PREROUTING -s 239.255.102.0/24 -j DROP
-A PREROUTING -s 52.192.7.0/24 -j DROP
-A PREROUTING -s 15.164.81.0/24 -j DROP
-A PREROUTING -s 131.253.18.12 -j DROP
-A PREROUTING -s 187.20.38.214 -j DROP
-A PREROUTING -s 217.147.169.242 -j DROP
-A PREROUTING -s 91.200.14.139 -j DROP
-A PREROUTING -s 217.23.5.57 -j DROP
-A PREROUTING -s 5.254.98.54 -j DROP
-A PREROUTING -s 5.61.39.14 -j DROP
-A PREROUTING -s 50.17.189.198 -j DROP
-A PREROUTING -s 50.21.187.135 -j DROP
-A PREROUTING -s 50.23.98.194 -j DROP
-A PREROUTING -s 50.62.235.1 -j DROP
-A PREROUTING -s 50.62.31.207 -j DROP
-A PREROUTING -s 50.63.56.47 -j DROP
-A PREROUTING -s 50.87.146.115 -j DROP
-A PREROUTING -s 50.87.151.146 -j DROP
-A PREROUTING -s 50.87.153.96 -j DROP
-A PREROUTING -s 50.87.18.127 -j DROP
-A PREROUTING -s 50.87.72.219 -j DROP
-A PREROUTING -s 50.97.234.2 -j DROP
-A PREROUTING -s 52.10.128.168 -j DROP
-A PREROUTING -s 52.207.234.89 -j DROP
-A PREROUTING -s 54.209.159.227 -j DROP
-A PREROUTING -s 54.218.45.67 -j DROP
-A PREROUTING -s 54.228.191.94 -j DROP
-A PREROUTING -s 54.236.134.245 -j DROP
-A PREROUTING -s 54.239.172.114 -j DROP
-A PREROUTING -s 54.248.126.242 -j DROP
-A PREROUTING -s 54.72.9.51 -j DROP
-A PREROUTING -s 58.215.169.42 -j DROP
-A PREROUTING -s 58.215.240.96 -j DROP
-A PREROUTING -s 58.55.127.16 -j DROP
-A PREROUTING -s 59.32.213.195 -j DROP
-A PREROUTING -s 60.250.76.52 -j DROP
-A PREROUTING -s 61.139.126.15 -j DROP
-A PREROUTING -s 61.147.75.89 -j DROP
-A PREROUTING -s 61.158.145.141 -j DROP
-A PREROUTING -s 61.178.85.177 -j DROP
-A PREROUTING -s 61.19.251.27 -j DROP
-A PREROUTING -s 61.57.227.5 -j DROP
-A PREROUTING -s 41.207.222.252 -j DROP
-A PREROUTING -s 101.0.89.3 -j DROP
-A PREROUTING -s 101.200.81.187 -j DROP
-A PREROUTING -s 103.19.89.118 -j DROP
-A PREROUTING -s 103.230.84.239 -j DROP
-A PREROUTING -s 103.241.0.100 -j DROP
-A PREROUTING -s 103.26.128.84 -j DROP
-A PREROUTING -s 103.4.52.150 -j DROP
-A PREROUTING -s 103.7.59.135 -j DROP
-A PREROUTING -s 107.191.46.4 -j DROP
-A PREROUTING -s 109.127.8.242 -j DROP
-A PREROUTING -s 109.229.210.250 -j DROP
-A PREROUTING -s 109.229.36.65 -j DROP
-A PREROUTING -s 113.29.230.24 -j DROP
-A PREROUTING -s 116.193.77.118 -j DROP
-A PREROUTING -s 120.25.63.2 -j DROP
-A PREROUTING -s 120.31.134.133 -j DROP
-A PREROUTING -s 120.63.157.195 -j DROP
-A PREROUTING -s 123.30.129.179 -j DROP
-A PREROUTING -s 124.110.195.160 -j DROP
-A PREROUTING -s 128.210.157.251 -j DROP
-A PREROUTING -s 149.202.242.81 -j DROP
-A PREROUTING -s 151.80.52.45 -j DROP
-A PREROUTING -s 151.80.52.47 -j DROP
-A PREROUTING -s 151.97.190.239 -j DROP
-A PREROUTING -s 157.7.170.62 -j DROP
-A PREROUTING -s 160.97.52.229 -j DROP
-A PREROUTING -s 162.223.94.56 -j DROP
-A PREROUTING -s 177.4.23.159 -j DROP
-A PREROUTING -s 180.182.234.200 -j DROP
-A PREROUTING -s 185.25.117.49 -j DROP
-A PREROUTING -s 185.25.119.84 -j DROP
-A PREROUTING -s 185.35.138.22 -j DROP
-A PREROUTING -s 185.62.188.51 -j DROP
-A PREROUTING -s 185.99.133.163 -j DROP
-A PREROUTING -s 186.64.120.104 -j DROP
-A PREROUTING -s 187.174.252.247 -j DROP
-A PREROUTING -s 188.219.154.228 -j DROP
-A PREROUTING -s 188.226.141.142 -j DROP
-A PREROUTING -s 188.241.140.212 -j DROP
-A PREROUTING -s 188.241.140.222 -j DROP
-A PREROUTING -s 188.241.140.224 -j DROP
-A PREROUTING -s 188.247.135.53 -j DROP
-A PREROUTING -s 188.247.135.58 -j DROP
-A PREROUTING -s 188.247.135.74 -j DROP
-A PREROUTING -s 188.247.135.99 -j DROP
-A PREROUTING -s 190.123.35.140 -j DROP
-A PREROUTING -s 190.123.35.141 -j DROP
-A PREROUTING -s 190.128.29.1 -j DROP
-A PREROUTING -s 190.15.192.25 -j DROP
-A PREROUTING -s 192.64.11.244 -j DROP
-A PREROUTING -s 192.99.148.26 -j DROP
-A PREROUTING -s 192.99.19.4 -j DROP
-A PREROUTING -s 193.107.17.145 -j DROP
-A PREROUTING -s 193.107.17.55 -j DROP
-A PREROUTING -s 193.107.17.56 -j DROP
-A PREROUTING -s 193.107.19.24 -j DROP
-A PREROUTING -s 193.107.19.244 -j DROP
-A PREROUTING -s 193.146.210.69 -j DROP
-A PREROUTING -s 193.189.117.56 -j DROP
-A PREROUTING -s 193.201.227.142 -j DROP
-A PREROUTING -s 194.109.64.131 -j DROP
-A PREROUTING -s 194.58.103.199 -j DROP
-A PREROUTING -s 194.58.56.45 -j DROP
-A PREROUTING -s 195.20.40.123 -j DROP
-A PREROUTING -s 195.20.41.233 -j DROP
-A PREROUTING -s 195.20.42.1 -j DROP
-A PREROUTING -s 195.20.44.100 -j DROP
-A PREROUTING -s 195.20.44.109 -j DROP
-A PREROUTING -s 195.20.46.116 -j DROP
-A PREROUTING -s 198.245.202.92 -j DROP
-A PREROUTING -s 199.187.129.193 -j DROP
-A PREROUTING -s 199.201.121.185 -j DROP
-A PREROUTING -s 199.7.234.100 -j DROP
-A PREROUTING -s 2.50.11.28 -j DROP
-A PREROUTING -s 201.149.83.183 -j DROP
-A PREROUTING -s 202.144.144.195 -j DROP
-A PREROUTING -s 202.191.62.226 -j DROP
-A PREROUTING -s 202.29.22.38 -j DROP
-A PREROUTING -s 202.29.230.198 -j DROP
-A PREROUTING -s 202.67.13.107 -j DROP
-A PREROUTING -s 202.9.36.111 -j DROP
-A PREROUTING -s 203.170.193.23 -j DROP
-A PREROUTING -s 209.164.84.70 -j DROP
-A PREROUTING -s 210.211.108.215 -j DROP
-A PREROUTING -s 210.4.76.221 -j DROP
-A PREROUTING -s 212.44.64.202 -j DROP
-A PREROUTING -s 213.147.67.20 -j DROP
-A PREROUTING -s 216.176.100.240 -j DROP
-A PREROUTING -s 216.215.112.149 -j DROP
-A PREROUTING -s 217.12.202.85 -j DROP
-A PREROUTING -s 222.29.197.232 -j DROP
-A PREROUTING -s 23.113.113.105 -j DROP
-A PREROUTING -s 23.94.5.119 -j DROP
-A PREROUTING -s 23.96.196.120 -j DROP
-A PREROUTING -s 24.148.217.188 -j DROP
-A PREROUTING -s 24.172.94.180 -j DROP
-A PREROUTING -s 24.204.49.244 -j DROP
-A PREROUTING -s 27.131.149.102 -j DROP
-A PREROUTING -s 27.254.55.11 -j DROP
-A PREROUTING -s 31.131.139.42 -j DROP
-A PREROUTING -s 31.131.251.33 -j DROP
-A PREROUTING -s 31.134.100.179 -j DROP
-A PREROUTING -s 31.134.73.151 -j DROP
-A PREROUTING -s 31.14.134.47 -j DROP
-A PREROUTING -s 31.222.155.254 -j DROP
-A PREROUTING -s 31.23.128.204 -j DROP
-A PREROUTING -s 31.23.80.184 -j DROP
-A PREROUTING -s 31.28.103.254 -j DROP
-A PREROUTING -s 31.41.44.45 -j DROP
-A PREROUTING -s 31.42.172.36 -j DROP
-A PREROUTING -s 31.7.63.146 -j DROP
-A PREROUTING -s 37.123.99.188 -j DROP
-A PREROUTING -s 37.128.132.96 -j DROP
-A PREROUTING -s 37.139.30.95 -j DROP
-A PREROUTING -s 37.140.195.177 -j DROP
-A PREROUTING -s 37.143.11.189 -j DROP
-A PREROUTING -s 37.229.126.164 -j DROP
-A PREROUTING -s 37.46.131.153 -j DROP
-A PREROUTING -s 37.46.135.204 -j DROP
-A PREROUTING -s 37.48.125.119 -j DROP
-A PREROUTING -s 37.57.177.15 -j DROP
-A PREROUTING -s 37.58.112.101 -j DROP
-A PREROUTING -s 37.59.61.29 -j DROP
-A PREROUTING -s 37.99.146.27 -j DROP
-A PREROUTING -s 38.64.199.113 -j DROP
-A PREROUTING -s 38.64.199.33 -j DROP
-A PREROUTING -s 41.144.68.21 -j DROP
-A PREROUTING -s 41.189.45.166 -j DROP
-A PREROUTING -s 41.189.52.14 -j DROP
-A PREROUTING -s 41.189.53.94 -j DROP
-A PREROUTING -s 41.202.71.27 -j DROP
-A PREROUTING -s 41.202.78.237 -j DROP
-A PREROUTING -s 41.202.90.185 -j DROP
-A PREROUTING -s 41.207.11.79 -j DROP
-A PREROUTING -s 41.207.2.186 -j DROP
-A PREROUTING -s 41.207.203.238 -j DROP
-A PREROUTING -s 41.207.220.170 -j DROP
-A PREROUTING -s 41.207.220.57 -j DROP
-A PREROUTING -s 41.207.24.201 -j DROP
-A PREROUTING -s 41.207.64.49 -j DROP
-A PREROUTING -s 41.38.18.230 -j DROP
-A PREROUTING -s 41.66.35.238 -j DROP
-A PREROUTING -s 41.66.39.42 -j DROP
-A PREROUTING -s 41.79.173.47 -j DROP
-A PREROUTING -s 41.86.46.245 -j DROP
-A PREROUTING -s 42.117.2.85 -j DROP
-A PREROUTING -s 45.124.65.51 -j DROP
-A PREROUTING -s 45.127.92.179 -j DROP
-A PREROUTING -s 45.46.51.81 -j DROP
-A PREROUTING -s 45.55.136.31 -j DROP
-A PREROUTING -s 46.151.52.191 -j DROP
-A PREROUTING -s 46.151.52.61 -j DROP
-A PREROUTING -s 46.16.200.133 -j DROP
-A PREROUTING -s 46.161.2.60 -j DROP
-A PREROUTING -s 46.161.40.102 -j DROP
-A PREROUTING -s 46.161.40.106 -j DROP
-A PREROUTING -s 46.165.222.231 -j DROP
-A PREROUTING -s 46.19.136.211 -j DROP
-A PREROUTING -s 46.22.128.133 -j DROP
-A PREROUTING -s 46.22.134.78 -j DROP
-A PREROUTING -s 46.31.43.57 -j DROP
-A PREROUTING -s 46.33.54.45 -j DROP
-A PREROUTING -s 46.4.150.111 -j DROP
-A PREROUTING -s 46.4.203.213 -j DROP
-A PREROUTING -s 5.100.249.215 -j DROP
-A PREROUTING -s 5.135.28.113 -j DROP
-A PREROUTING -s 5.139.154.42 -j DROP
-A PREROUTING -s 5.152.199.70 -j DROP
-A PREROUTING -s 5.152.201.19 -j DROP
-A PREROUTING -s 5.172.193.101 -j DROP
-A PREROUTING -s 5.187.0.137 -j DROP
-A PREROUTING -s 5.187.193.224 -j DROP
-A PREROUTING -s 5.187.4.183 -j DROP
-A PREROUTING -s 5.196.249.163 -j DROP
-A PREROUTING -s 5.206.225.104 -j DROP
-A PREROUTING -s 5.9.253.173 -j DROP
-A PREROUTING -s 5.9.82.18 -j DROP
-A PREROUTING -s 50.62.233.1 -j DROP
-A PREROUTING -s 52.39.53.151 -j DROP
-A PREROUTING -s 58.195.1.4 -j DROP
-A PREROUTING -s 59.157.4.2 -j DROP
-A PREROUTING -s 60.13.186.5 -j DROP
-A PREROUTING -s 60.241.184.209 -j DROP
-A PREROUTING -s 60.249.31.231 -j DROP
-A PREROUTING -s 61.14.209.167 -j DROP
-A PREROUTING -s 61.47.43.241 -j DROP
-A PREROUTING -s 62.76.191.108 -j DROP
-A PREROUTING -s 63.249.152.74 -j DROP
-A PREROUTING -s 63.250.54.134 -j DROP
-A PREROUTING -s 64.127.71.73 -j DROP
-A PREROUTING -s 64.182.215.68 -j DROP
-A PREROUTING -s 64.182.6.61 -j DROP
-A PREROUTING -s 64.76.19.244 -j DROP
-A PREROUTING -s 64.76.19.251 -j DROP
-A PREROUTING -s 64.85.233.8 -j DROP
-A PREROUTING -s 69.118.144.195 -j DROP
-A PREROUTING -s 69.144.171.44 -j DROP
-A PREROUTING -s 69.15.194.26 -j DROP
-A PREROUTING -s 69.23.87.56 -j DROP
-A PREROUTING -s 72.167.245.34 -j DROP
-A PREROUTING -s 72.230.82.80 -j DROP
-A PREROUTING -s 72.41.18.212 -j DROP
-A PREROUTING -s 73.72.208.195 -j DROP
-A PREROUTING -s 74.119.194.18 -j DROP
-A PREROUTING -s 74.62.209.104 -j DROP
-A PREROUTING -s 78.138.104.167 -j DROP
-A PREROUTING -s 78.46.222.241 -j DROP
-A PREROUTING -s 80.65.93.241 -j DROP
-A PREROUTING -s 81.177.180.101 -j DROP
-A PREROUTING -s 82.196.3.245 -j DROP
-A PREROUTING -s 83.15.254.242 -j DROP
-A PREROUTING -s 83.212.117.233 -j DROP
-A PREROUTING -s 83.69.233.121 -j DROP
-A PREROUTING -s 87.236.210.110 -j DROP
-A PREROUTING -s 87.236.210.124 -j DROP
-A PREROUTING -s 87.237.198.245 -j DROP
-A PREROUTING -s 87.246.143.242 -j DROP
-A PREROUTING -s 87.254.167.37 -j DROP
-A PREROUTING -s 89.40.181.101 -j DROP
-A PREROUTING -s 90.80.231.36 -j DROP
-A PREROUTING -s 91.108.176.118 -j DROP
-A PREROUTING -s 91.121.240.111 -j DROP
-A PREROUTING -s 91.121.240.97 -j DROP
-A PREROUTING -s 91.195.12.143 -j DROP
-A PREROUTING -s 91.201.155.96 -j DROP
-A PREROUTING -s 91.224.141.11 -j DROP
-A PREROUTING -s 91.236.213.74 -j DROP
-A PREROUTING -s 91.236.75.11 -j DROP
-A PREROUTING -s 92.53.119.248 -j DROP
-A PREROUTING -s 92.53.124.62 -j DROP
-A PREROUTING -s 93.171.205.12 -j DROP
-A PREROUTING -s 94.103.36.55 -j DROP
-A PREROUTING -s 95.211.153.134 -j DROP
-A PREROUTING -s 98.126.6.83 -j DROP
-A PREROUTING -s 98.131.185.136 -j DROP
-A PREROUTING -s 192.42.119.41 -j DROP
-A PREROUTING -s 23.254.203.51 -j DROP
-A PREROUTING -s 81.177.140.212 -j DROP
-A PREROUTING -s 212.83.166.45 -j DROP
-A PREROUTING -s 173.230.136.67 -j DROP
-A PREROUTING -s 173.224.218.25 -j DROP
-A PREROUTING -s 104.227.137.34 -j DROP
-A PREROUTING -s 137.74.254.64 -j DROP
-A PREROUTING -s 188.165.220.214 -j DROP
-A PREROUTING -s 85.143.221.180 -j DROP
-A PREROUTING -s 119.82.27.246 -j DROP
-A PREROUTING -s 194.88.246.7 -j DROP
-A PREROUTING -s 206.214.220.79 -j DROP
-A PREROUTING -s 104.236.2.253 -j DROP
-A PREROUTING -s 62.39.95.185 -j DROP
-A PREROUTING -s 209.97.168.52 -j DROP
# ------------------------------------------


# 동기화되지 않은 새 패킷을 차단합니다. 문제가 있을경우 361번째줄을 제거해주세요.
 -A PREROUTING -p tcp ! --syn -m conntrack --ctstate NEW -j DROP 

-A PREROUTING -s 224.0.0.0/3 -j DROP
-A PREROUTING -s 192.0.2.0/24 -j DROP
-A PREROUTING -s 192.168.0.0/16 -j DROP
-A PREROUTING -s 10.0.0.0/8 -j DROP
-A PREROUTING -s 240.0.0.0/5 -j DROP

# 조각난 패킷을 차단합니다.
 -A PREROUTING -f -j DROP

-A PREROUTING -p tcp -m length --length 0:10 -j DROP
-A PREROUTING -p udp -m length --length 0:10 -j DROP

# 가짜 tcp flags가 있는 패킷을 차단합니다. ------------------------------------------------------------
-A PREROUTING -p tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP 
-A PREROUTING -p tcp --tcp-flags FIN,SYN FIN,SYN -j DROP 
-A PREROUTING -p tcp --tcp-flags SYN,RST SYN,RST -j DROP 
-A PREROUTING -p tcp --tcp-flags FIN,RST FIN,RST -j DROP 
-A PREROUTING -p tcp --tcp-flags FIN,ACK FIN -j DROP 
-A PREROUTING -p tcp --tcp-flags ACK,URG URG -j DROP 
-A PREROUTING -p tcp --tcp-flags ACK,FIN FIN -j DROP 
-A PREROUTING -p tcp --tcp-flags ACK,PSH PSH -j DROP 
-A PREROUTING -p tcp --tcp-flags ALL ALL -j DROP 
-A PREROUTING -p tcp --tcp-flags ALL NONE -j DROP 
-A PREROUTING -p tcp --tcp-flags ALL FIN,PSH,URG -j DROP 
-A PREROUTING -p tcp --tcp-flags ALL SYN,FIN,PSH,URG -j DROP 
-A PREROUTING -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP  
# -------------------------------------------------------------------------------------------------------

-A PREROUTING -p tcp -m multiport --dports 23,79 -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG SYN -m recent --set --name blacklist_180 --mask 255.255.255.255 --rsource -j DROP
COMMIT
